<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM-017 IoT Dashboard</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-glow: #0ff;
            --secondary-glow: #f0f;
            --bg-color: #050505;
            --panel-bg: rgba(16, 20, 24, 0.8);
            --border-color: #0ff;
        }

        body {
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            text-transform: uppercase;
            letter-spacing: 5px;
            text-shadow: 0 0 10px var(--primary-glow);
            margin-bottom: 5px;
        }

        #status {
            font-size: 0.8rem;
            color: #555;
            margin-bottom: 30px;
        }

        .status-connected { color: #0f0 !important; text-shadow: 0 0 5px #0f0; }
        .status-disconnected { color: #f00 !important; text-shadow: 0 0 5px #f00; }

        /* Container Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 1000px;
        }

        /* Card Style */
        .card {
            background: var(--panel-bg);
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: 20px;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
            clip-path: polygon(
                10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%
            ); /* Bentuk sudut futuristik */
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.2);
            border-color: var(--primary-glow);
        }

        /* Label */
        .card-label {
            font-size: 1rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        /* Seven Segment Value */
        .value {
            font-family: 'Digital-7 Mono', monospace;
            font-size: 4rem;
            color: var(--primary-glow);
            text-shadow: 0 0 10px var(--primary-glow);
            text-align: right;
            line-height: 1;
        }

        .unit {
            font-size: 1.5rem;
            font-family: 'Orbitron', sans-serif;
            color: white;
            text-shadow: none;
            margin-left: 5px;
        }

        /* Warna Khusus per elemen */
        .v-color { color: #00eaff; text-shadow: 0 0 10px #00eaff; } /* Cyan */
        .a-color { color: #ff0055; text-shadow: 0 0 10px #ff0055; } /* Pink/Red */
        .w-color { color: #00ff66; text-shadow: 0 0 10px #00ff66; } /* Green */
        .e-color { color: #ffee00; text-shadow: 0 0 10px #ffee00; } /* Yellow */

        /* Dekorasi sudut */
        .corner {
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid white;
            opacity: 0.5;
        }
        .top-right { top: 5px; right: 5px; border-bottom: none; border-left: none; }
        .bottom-left { bottom: 5px; left: 5px; border-top: none; border-right: none; }

        footer {
            margin-top: 50px;
            font-size: 0.7rem;
            color: #444;
        }
    </style>
</head>
<body>

    <h1>Power Monitor System</h1>
    <div id="status" class="status-disconnected">System Status: CONNECTING...</div>

    <div class="dashboard">
        <div class="card">
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="card-label">Voltage / Tegangan</div>
            <div class="value v-color">
                <span id="val-volt">000</span><span class="unit">V</span>
            </div>
        </div>

        <div class="card">
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="card-label">Current / Arus</div>
            <div class="value a-color">
                <span id="val-amp">0.00</span><span class="unit">A</span>
            </div>
        </div>

        <div class="card">
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="card-label">Active Power / Daya</div>
            <div class="value w-color">
                <span id="val-watt">0000</span><span class="unit">W</span>
            </div>
        </div>

        <div class="card">
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="card-label">Total Energy</div>
            <div class="value e-color">
                <span id="val-kwh">000.0</span><span class="unit">kWh</span>
            </div>
        </div>
    </div>

    <footer>
        IOT SYSTEM | PZEM-017 | MQTT WEBSOCKET
    </footer>

    <script>
        // --- KONFIGURASI MQTT ---
        // Gunakan Port WSS (Secure WebSocket) karena GitHub Pages menggunakan HTTPS
        // Untuk broker.emqx.io, port WSS adalah 8084
        const mqtt_broker = "broker.emqx.io";
        const mqtt_port = 8084; 
        const mqtt_topic = "kampus/pzem017/data"; // Harus SAMA PERSIS dengan Python
        const client_id = "web_dashboard_" + Math.random().toString(16).substr(2, 8);

        // Membuat Client
        const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, client_id);

        // Handler saat koneksi putus
        client.onConnectionLost = function (responseObject) {
            console.log("Connection Lost: " + responseObject.errorMessage);
            document.getElementById("status").innerHTML = "System Status: DISCONNECTED";
            document.getElementById("status").className = "status-disconnected";
        };

        // Handler saat pesan masuk
        client.onMessageArrived = function (message) {
            console.log("Data diterima: " + message.payloadString);
            
            try {
                // Parsing data JSON dari Python
                const data = JSON.parse(message.payloadString);

                // Update tampilan HTML (dengan format angka fixed decimal)
                // Tegangan
                document.getElementById("val-volt").innerText = parseFloat(data.tegangan).toFixed(0); 
                
                // Arus
                document.getElementById("val-amp").innerText = parseFloat(data.arus).toFixed(2);
                
                // Daya
                document.getElementById("val-watt").innerText = parseFloat(data.daya).toFixed(1);
                
                // Energi
                document.getElementById("val-kwh").innerText = parseFloat(data.energi).toFixed(3);

                // Efek kedip visual saat data masuk (opsional)
                const cards = document.querySelectorAll('.card');
                cards.forEach(card => {
                    card.style.borderColor = '#fff';
                    setTimeout(() => card.style.borderColor = 'rgba(0, 255, 255, 0.3)', 100);
                });

            } catch (e) {
                console.error("Error parsing JSON: ", e);
            }
        };

        // Opsi Koneksi
        const options = {
            useSSL: true, // Wajib True untuk GitHub Pages
            onSuccess: function () {
                console.log("MQTT Connected!");
                document.getElementById("status").innerHTML = "System Status: ONLINE LINK ESTABLISHED";
                document.getElementById("status").className = "status-connected";
                
                // Subscribe ke topik
                client.subscribe(mqtt_topic);
            },
            onFailure: function (message) {
                console.log("Connection Failed: " + message.errorMessage);
                document.getElementById("status").innerHTML = "System Status: CONNECTION FAILED";
                document.getElementById("status").className = "status-disconnected";
            }
        };

        // Mulai Koneksi
        console.log("Connecting to MQTT Broker...");
        client.connect(options);

    </script>
</body>
</html>
